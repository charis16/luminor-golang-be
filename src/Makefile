# Makefile untuk development backend Go

GO := go

# â¬‡ï¸ Load variable dari file .env
include .env
export

# ğŸ” Jalankan Air untuk auto-reload saat dev
dev:
	air

# â–¶ï¸ Jalankan aplikasi langsung
run:
	$(GO) run main.go

# ğŸ›  Generate model GORM dari database (via ./cmd/gen)
gen-model:
	$(GO) run ./cmd/gen

# ğŸ”„ Bersihkan file hasil generate GORM
clean-models:
	rm -f models/*_gen.go

# ğŸ§± Buat file migration baru (interaktif)
new-migration:
	@read -p "Migration name (snake_case): " name; \
	mkdir -p migrations; \
	timestamp=$$(date +%Y%m%d%H%M%S); \
	touch "migrations/$${timestamp}_$${name}.up.sql"; \
	touch "migrations/$${timestamp}_$${name}.down.sql"; \
	echo "âœ… Created migrations/$${timestamp}_$${name}.up.sql & down.sql"

# ğŸš€ Jalankan semua migration (UP)
migrate-up:
	migrate -path migrations -database "postgres://$(DB_USER):$(DB_PASSWORD)@$(DB_HOST):$(DB_PORT)/$(DB_NAME)?sslmode=$(DB_SSLMODE)" up

# âª Rollback 1 step (DOWN)
migrate-down:
	migrate -path migrations -database "postgres://$(DB_USER):$(DB_PASSWORD)@$(DB_HOST):$(DB_PORT)/$(DB_NAME)?sslmode=$(DB_SSLMODE)" down 1

# ğŸ”§ Format semua file Go
fmt:
	$(GO) fmt ./...

# ğŸ“¦ Install atau bersihkan dependency
deps:
	$(GO) mod tidy

# ğŸ”„ Regenerate model full (clean + generate)
regen-models: clean-models gen-model